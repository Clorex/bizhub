== BIZHUB SNAPSHOT PACK 1/10 ==
Date: 2/1/2026 10:12:43 AM
Node: v24.12.0
NPM: 11.6.2
Approx bytes in this pack: 75154

----- ROUTES -----
== ROUTES (src/app) ==
src\app\account\forgot\page.tsx
src\app\account\invite\page.tsx
src\app\account\login\page.tsx
src\app\account\page.tsx
src\app\account\register\page.tsx
src\app\account\verify\page.tsx
src\app\admin\analytics\page.tsx
src\app\admin\customers\page.tsx
src\app\admin\disputes\page.tsx
src\app\admin\finance\page.tsx
src\app\admin\layout.tsx
src\app\admin\packages\page.tsx
src\app\admin\page.tsx
src\app\admin\reports\page.tsx
src\app\admin\vendors\[businessId]\page.tsx
src\app\admin\vendors\page.tsx
src\app\admin\verification\page.tsx
src\app\admin\withdrawals\page.tsx
src\app\api\admin\analytics\platform\route.ts
src\app\api\admin\bootstrap\route.ts
src\app\api\admin\buyers\freeze\route.ts
src\app\api\admin\customers\route.ts
src\app\api\admin\disputes\route.ts
src\app\api\admin\finance\route.ts
src\app\api\admin\plan-config\route.ts
src\app\api\admin\reports\daily\route.ts
src\app\api\admin\vendors\[businessId]\analytics\route.ts
src\app\api\admin\vendors\route.ts
src\app\api\admin\verification\route.ts
src\app\api\admin\withdrawals\route.ts
src\app\api\auth\send-email-code\route.ts
src\app\api\auth\verify-email-code\route.ts
src\app\api\customer\onboard\route.ts
src\app\api\disputes\create\route.ts
src\app\api\escrow\confirm\route.ts
src\app\api\escrow\release\route.ts
src\app\api\escrow\sweep\route.ts
src\app\api\marketing\optout\route.ts
src\app\api\me\route.ts
src\app\api\orders\chat\create\route.ts
src\app\api\orders\direct\create\route.ts
src\app\api\paystack\initialize\route.ts
src\app\api\paystack\verify\route.ts
src\app\api\promotions\confirm\route.ts
src\app\api\promotions\initialize\route.ts
src\app\api\promotions\my\route.ts
src\app\api\staff\accept\route.ts
src\app\api\subscriptions\confirm\route.ts
src\app\api\subscriptions\initialize\route.ts
src\app\api\subscriptions\my\route.ts
src\app\api\track\route.ts
src\app\api\uploads\cloudinary\sign\route.ts
src\app\api\vendor\access\route.ts
src\app\api\vendor\analytics\route.ts
src\app\api\vendor\assistant\summary\route.ts
src\app\api\vendor\chat\availability\route.ts
src\app\api\vendor\coupons\route.ts
src\app\api\vendor\coupons\validate\route.ts
src\app\api\vendor\onboard\route.ts
src\app\api\vendor\orders\[orderId]\notes\route.ts
src\app\api\vendor\orders\[orderId]\ops-status\route.ts
src\app\api\vendor\orders\[orderId]\route.ts
src\app\api\vendor\orders\route.ts
src\app\api\vendor\payout-details\route.ts
src\app\api\vendor\products\[productId]\route.ts
src\app\api\vendor\products\route.ts
src\app\api\vendor\reengagement\audience\route.ts
src\app\api\vendor\reengagement\send\route.ts
src\app\api\vendor\shipping\options\route.ts
src\app\api\vendor\shipping\route.ts
src\app\api\vendor\staff\route.ts
src\app\api\vendor\store\route.ts
src\app\api\vendor\verification\route.ts
src\app\api\vendor\wallet\route.ts
src\app\api\vendor\withdrawals\route.ts
src\app\b\[slug]\checkout\page.tsx
src\app\b\[slug]\p\[productId]\page.tsx
src\app\b\[slug]\page.tsx
src\app\b\[slug]\pay\direct\page.tsx
src\app\cart\page.tsx
src\app\layout.tsx
src\app\market\page.tsx
src\app\orders\[orderId]\dispute\page.tsx
src\app\orders\[orderId]\page.tsx
src\app\orders\page.tsx
src\app\page.tsx
src\app\payment\callback\page.tsx
src\app\payment\promotion\callback\page.tsx
src\app\payment\subscription\callback\page.tsx
src\app\vendor\analytics\page.tsx
src\app\vendor\coupon\page.tsx
src\app\vendor\layout.tsx
src\app\vendor\more\page.tsx
src\app\vendor\orders\[orderId]\dispute\page.tsx
src\app\vendor\orders\[orderId]\page.tsx
src\app\vendor\orders\page.tsx
src\app\vendor\page.tsx
src\app\vendor\products\[productId]\edit\page.tsx
src\app\vendor\products\new\page.tsx
src\app\vendor\products\page.tsx
src\app\vendor\promote\faq\page.tsx
src\app\vendor\promote\page.tsx
src\app\vendor\promotions\page.tsx
src\app\vendor\reengagement\page.tsx
src\app\vendor\settings\payouts\page.tsx
src\app\vendor\shipping\page.tsx
src\app\vendor\staff\page.tsx
src\app\vendor\store\page.tsx
src\app\vendor\subscription\page.tsx
src\app\vendor\subscription\summary\page.tsx
src\app\vendor\verification\page.tsx
src\app\vendor\wallet\page.tsx
src\app\vendor\withdrawals\page.tsx

----- ENV TEMPLATE (names only; DO NOT paste secrets) -----
ADMIN_EMAILS=
PAYSTACK_SECRET_KEY=
NEXT_PUBLIC_APP_URL=
NEXT_PUBLIC_FIREBASE_API_KEY=
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=
NEXT_PUBLIC_FIREBASE_PROJECT_ID=
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=
NEXT_PUBLIC_FIREBASE_APP_ID=
SMTP_HOST=
SMTP_PORT=
SMTP_SECURE=
SMTP_USER=
SMTP_PASS=
SMTP_FROM=

== FILE LIST (relative path + bytes) ==
src\app\vendor\products\page.tsx  (bytes: 12476)
src\app\vendor\orders\[orderId]\page.tsx  (bytes: 12390)
src\app\admin\packages\page.tsx  (bytes: 8328)
src\app\api\escrow\confirm\route.ts  (bytes: 6945)
src\app\admin\verification\page.tsx  (bytes: 6240)
src\app\api\vendor\reengagement\send\route.ts  (bytes: 5275)
src\app\api\vendor\coupons\route.ts  (bytes: 4922)
src\app\payment\promotion\callback\page.tsx  (bytes: 3668)
src\app\admin\reports\page.tsx  (bytes: 3106)
src\app\account\forgot\page.tsx  (bytes: 2655)
src\app\api\admin\vendors\route.ts  (bytes: 2334)
src\app\api\subscriptions\my\route.ts  (bytes: 1730)
src\app\api\escrow\sweep\route.ts  (bytes: 1466)
src\components\ui\AppHeader.tsx  (bytes: 1260)
src\lib\firebase\storefront.ts  (bytes: 1099)
src\components\Card.tsx  (bytes: 650)
src\lib\entitlements\server.ts  (bytes: 610)

----- FILE: src\app\vendor\products\page.tsx -----
// FILE: src/app/vendor/products/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { auth } from "@/lib/firebase/client";

import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { EmptyState } from "@/components/ui/EmptyState";
import { IconButton } from "@/components/ui/IconButton";

import { Plus, RefreshCw, Search, Megaphone, Share2, Copy, Lock } from "lucide-react";

function fmtNaira(n: number) {
  try {
    return `â‚¦${Number(n || 0).toLocaleString()}`;
  } catch {
    return `â‚¦${n}`;
  }
}

function Chip({
  children,
  tone = "neutral",
}: {
  children: React.ReactNode;
  tone?: "neutral" | "good" | "warn";
}) {
  const cls =
    tone === "good"
      ? "bg-emerald-50 text-emerald-700 border-emerald-100"
      : tone === "warn"
        ? "bg-orange-50 text-orange-700 border-orange-100"
        : "bg-white text-gray-700 border-biz-line";

  return (
    <span className={`inline-flex items-center px-3 py-1 rounded-full text-[11px] font-bold border ${cls}`}>
      {children}
    </span>
  );
}

function waShareLink(text: string) {
  return `https://wa.me/?text=${encodeURIComponent(text)}`;
}

function buildShareCaption(p: any) {
  const name = String(p?.name || "Product");
  const price = Number(p?.price || 0);
  const slug = String(p?.businessSlug || "");
  const origin = typeof window !== "undefined" ? window.location.origin : "";
  const link = slug && p?.id ? `${origin}/b/${slug}/p/${p.id}` : "";

  const lines: string[] = [];
  lines.push(name);
  if (price > 0) lines.push(`Price: ${fmtNaira(price)}`);
  if (link) lines.push(`Link: ${link}`);
  lines.push(`(You can checkout securely via BizHub)`);

  return lines.join("\n");
}

export default function VendorProductsPage() {
  const router = useRouter();

  const [items, setItems] = useState<any[]>([]);
  const [msg, setMsg] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const [q, setQ] = useState("");

  // plan info (to show â€œnot visible on marketâ€ notice)
  const [planKey, setPlanKey] = useState<string>("FREE");
  const [features, setFeatures] = useState<any>(null);

  // Share modal
  const [shareOpen, setShareOpen] = useState(false);
  const [shareText, setShareText] = useState("");
  const [shareTitle, setShareTitle] = useState("");

  async function load() {
    try {
      setLoading(true);
      setMsg(null);

      const token = await auth.currentUser?.getIdToken();

      const [pRes, prodRes] = await Promise.all([
        fetch("/api/vendor/access", { headers: { Authorization: `Bearer ${token}` } }),
        fetch("/api/vendor/products", { headers: { Authorization: `Bearer ${token}` } }),
      ]);

      const pData = await pRes.json().catch(() => ({}));
      const data = await prodRes.json().catch(() => ({}));

      if (!pRes.ok) throw new Error(pData?.error || "Failed to load access");
      if (!prodRes.ok) throw new Error(data?.error || "Failed to load products");

      setPlanKey(String(pData?.planKey || "FREE"));
      setFeatures(pData?.features || null);

      setItems(Array.isArray(data.products) ? data.products : []);
    } catch (e: any) {
      setMsg(e?.message || "Failed");
      setItems([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const filtered = useMemo(() => {
    const t = q.trim().toLowerCase();
    if (!t) return items;
    return items.filter((p) => String(p?.name || "").toLowerCase().includes(t));
  }, [items, q]);

  async function copyText(text: string) {
    try {
      await navigator.clipboard.writeText(text);
      setMsg("Copied.");
      setTimeout(() => setMsg(null), 1200);
    } catch {
      setMsg("Copy failed.");
      setTimeout(() => setMsg(null), 1200);
    }
  }

  function openShare(p: any) {
    const caption = buildShareCaption(p);
    setShareTitle(String(p?.name || "Share"));
    setShareText(caption);
    setShareOpen(true);
  }

  const marketOn = !!features?.marketplace;

  return (
    <div className="min-h-screen">
      <GradientHeader
        title="Products"
        subtitle="Create, manage, and promote"
        showBack={false}
        right={
          <div className="flex items-center gap-2">
            <IconButton aria-label="Refresh" onClick={load} disabled={loading}>
              <RefreshCw className="h-5 w-5 text-gray-700" />
            </IconButton>
            <IconButton aria-label="Add product" onClick={() => router.push("/vendor/products/new")}>
              <Plus className="h-5 w-5 text-gray-700" />
            </IconButton>
          </div>
        }
      />

      <div className="px-4 pb-6 space-y-3">
        {msg ? <Card className="p-4">{msg}</Card> : null}

        {/* Notice: FREE products not in marketplace */}
        {!marketOn ? (
          <Card className="p-4">
            <div className="flex items-start gap-3">
              <div className="h-10 w-10 rounded-2xl bg-biz-cream flex items-center justify-center">
                <Lock className="h-5 w-5 text-orange-700" />
              </div>
              <div className="flex-1 min-w-0">
                <p className="text-sm font-bold text-biz-ink">Marketplace visibility is off</p>
                <p className="text-xs text-biz-muted mt-1">
                  Your products can be sold with your store link, but they wonâ€™t appear in the marketplace on your current plan.
                  Upgrade to show products on Market.
                </p>
                <div className="mt-3">
                  <Button onClick={() => router.push("/vendor/subscription")}>Upgrade</Button>
                </div>
                <p className="mt-2 text-[11px] text-biz-muted">Plan: <b className="text-biz-ink">{planKey}</b></p>
              </div>
            </div>
          </Card>
        ) : null}

        <Card className="p-4">
          <div className="flex items-center gap-2">
            <div className="h-10 w-10 rounded-2xl bg-biz-cream flex items-center justify-center border border-transparent">
              <Search className="h-5 w-5 text-orange-700" />
            </div>
            <Input placeholder="Search productsâ€¦" value={q} onChange={(e) => setQ(e.target.value)} />
          </div>

          <div className="mt-3 grid grid-cols-2 gap-2">
            <Button onClick={() => router.push("/vendor/products/new")} leftIcon={<Plus className="h-4 w-4" />}>
              Add product
            </Button>
            <Button variant="secondary" onClick={load} loading={loading}>
              Refresh
            </Button>
          </div>

          <div className="mt-3 rounded-2xl border border-biz-line bg-white p-3">
            <p className="text-xs text-biz-muted">
              Tip: Use <b className="text-biz-ink">Share</b> to send a ready caption + link to customers on WhatsApp.
            </p>
          </div>
        </Card>

        {loading && items.length === 0 ? <Card className="p-4">Loadingâ€¦</Card> : null}

        {!loading && items.length === 0 ? (
          <EmptyState title="No products yet" description="Add your first product to start selling and promoting." ctaLabel="Add product" onCta={() => router.push("/vendor/products/new")} />
        ) : null}

        {!loading && items.length > 0 && filtered.length === 0 ? (
          <EmptyState title="No matches" description="Try a different keyword." ctaLabel="Clear search" onCta={() => setQ("")} />
        ) : null}

        <div className="space-y-3">
          {filtered.map((p) => {
            const marketEnabled = p?.marketEnabled !== false;
            const slug = String(p?.businessSlug || "");
            const img = Array.isArray(p?.images) ? p.images[0] : "";
            const isService = String(p?.listingType || "product") === "service";
            const boosted = Number(p?.boostUntilMs || 0) > Date.now();

            return (
              <Card key={p.id} className="p-4">
                <div className="flex items-start gap-3">
                  <div className="h-16 w-16 rounded-2xl bg-biz-cream overflow-hidden shrink-0">
                    {img ? (
                      // eslint-disable-next-line @next/next/no-img-element
                      <img src={img} alt={p?.name || "Product"} className="h-full w-full object-cover" />
                    ) : null}
                  </div>

                  <div className="flex-1 min-w-0">
                    <div className="flex items-start justify-between gap-2">
                      <p className="font-bold text-biz-ink truncate">{p?.name || "Unnamed product"}</p>

                      <div className="flex items-center gap-2">
                        {boosted ? <Chip tone="good">Promoted</Chip> : null}
                        <Chip tone={marketEnabled ? "neutral" : "warn"}>{marketEnabled ? "Market: On" : "Market: Off"}</Chip>
                      </div>
                    </div>

                    <p className="text-sm text-gray-700 mt-1">
                      {isService ? "Service" : fmtNaira(p?.price || 0)} â€¢ Stock: <b>{Number(p?.stock ?? 0)}</b>
                    </p>

                    <div className="mt-2 flex flex-wrap gap-2">
                      <Chip>{p?.packaging || "Packaging"}</Chip>
                      {isService ? <Chip>Service</Chip> : null}
                    </div>
                  </div>
                </div>

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <Button variant="secondary" size="sm" onClick={() => router.push(`/vendor/products/${p.id}/edit`)}>
                    Edit
                  </Button>

                  <Button variant="secondary" size="sm" onClick={() => router.push(`/b/${slug}/p/${p.id}`)} disabled={!slug}>
                    View
                  </Button>

                  <Button
                    size="sm"
                    leftIcon={<Megaphone className="h-4 w-4" />}
                    onClick={() => router.push(`/vendor/promote?productId=${encodeURIComponent(p.id)}`)}
                    disabled={isService}
                  >
                    Promote
                  </Button>

                  <Button size="sm" variant="secondary" leftIcon={<Share2 className="h-4 w-4" />} onClick={() => openShare(p)} disabled={!slug}>
                    Share
                  </Button>
                </div>
              </Card>
            );
          })}
        </div>

        {shareOpen ? (
          <div className="fixed inset-0 z-50 bg-black/40 flex items-end justify-center">
            <div className="w-full max-w-[430px] px-4 safe-pb pb-4">
              <Card className="p-4">
                <p className="text-sm font-bold text-biz-ink">{shareTitle}</p>
                <p className="text-[11px] text-biz-muted mt-1">
                  This caption is auto-generated. You can edit or remove parts before sending.
                </p>

                <textarea
                  className="mt-3 w-full rounded-2xl border border-biz-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-biz-accent/30 focus:border-biz-accent/40"
                  value={shareText}
                  onChange={(e) => setShareText(e.target.value)}
                  rows={7}
                />

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <Button variant="secondary" leftIcon={<Copy className="h-4 w-4" />} onClick={() => copyText(shareText)}>
                    Copy
                  </Button>

                  <Button onClick={() => window.open(waShareLink(shareText), "_blank")}>WhatsApp</Button>

                  <Button variant="secondary" onClick={() => setShareOpen(false)} className="col-span-2">
                    Close
                  </Button>
                </div>
              </Card>
            </div>
          </div>
        ) : null}
      </div>
    </div>
  );
}

----- FILE: src\app\vendor\orders\[orderId]\page.tsx -----
// FILE: src/app/vendor/orders/[orderId]/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { auth } from "@/lib/firebase/client";
import { Button } from "@/components/ui/Button";
import { SectionCard } from "@/components/ui/SectionCard";
import { SegmentedControl } from "@/components/ui/SegmentedControl";
import { MessageCircle, AlertTriangle } from "lucide-react";

function fmtNaira(n: number) {
  try {
    return `â‚¦${Number(n || 0).toLocaleString()}`;
  } catch {
    return `â‚¦${n}`;
  }
}

function fmtDate(v: any) {
  try {
    if (!v) return "â€”";
    if (typeof v?.toDate === "function") return v.toDate().toLocaleString();
    return String(v);
  } catch {
    return "â€”";
  }
}

function digitsOnlyPhone(v: string) {
  return String(v || "").replace(/[^\d]/g, "");
}

function waLink(wa: string, text: string) {
  const digits = digitsOnlyPhone(wa);
  const t = encodeURIComponent(text);
  return `https://wa.me/${digits}?text=${t}`;
}

type Ops =
  | "new"
  | "contacted"
  | "paid"
  | "in_transit"
  | "delivered"
  | "cancelled";

const OPS_OPTIONS: { value: Ops; label: string }[] = [
  { value: "new", label: "New" },
  { value: "contacted", label: "Contacted" },
  { value: "paid", label: "Paid" },
  { value: "in_transit", label: "In transit" },
  { value: "delivered", label: "Delivered" },
  { value: "cancelled", label: "Cancelled" },
];

export default function VendorOrderDetailPage() {
  const router = useRouter();
  const params = useParams();
  const orderId = String((params as any)?.orderId ?? "");

  const [loading, setLoading] = useState(true);
  const [msg, setMsg] = useState<string | null>(null);

  const [meta, setMeta] = useState<any>(null);
  const [o, setO] = useState<any>(null);

  const [notes, setNotes] = useState<any[]>([]);
  const [noteText, setNoteText] = useState("");
  const [savingNote, setSavingNote] = useState(false);

  const [savingStatus, setSavingStatus] = useState(false);

  const items = useMemo(() => (Array.isArray(o?.items) ? o.items : []), [o]);
  const amount = Number(o?.amount || (o?.amountKobo ? o.amountKobo / 100 : 0) || 0);

  const canUpdateStatus = !!meta?.limits?.canUpdateStatus;
  const canUseNotes = !!meta?.limits?.canUseNotes;

  const disputed = String(o?.orderStatus || "").toLowerCase() === "disputed" || String(o?.escrowStatus || "").toLowerCase() === "disputed";

  async function authedFetch(path: string, init?: RequestInit) {
    const token = await auth.currentUser?.getIdToken();
    const r = await fetch(path, {
      ...init,
      headers: { ...(init?.headers || {}), Authorization: `Bearer ${token}` },
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data?.error || data?.code || "Request failed");
    return data;
  }

  async function load() {
    setLoading(true);
    setMsg(null);

    try {
      const data = await authedFetch(`/api/vendor/orders/${encodeURIComponent(orderId)}`);
      setMeta(data?.meta || null);
      setO(data?.order || null);

      if (data?.meta?.limits?.canUseNotes) {
        const n = await authedFetch(`/api/vendor/orders/${encodeURIComponent(orderId)}/notes`);
        setNotes(Array.isArray(n.notes) ? n.notes : []);
      } else {
        setNotes([]);
      }
    } catch (e: any) {
      setMsg(e?.message || "Failed to load order");
      setMeta(null);
      setO(null);
      setNotes([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (orderId) load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [orderId]);

  const opsValue: Ops = useMemo(() => {
    const v = String(o?.opsStatus || o?.opsStatusEffective || "").trim();
    const ok = (OPS_OPTIONS.map((x) => x.value) as string[]).includes(v);
    return (ok ? v : "new") as Ops;
  }, [o]);

  async function setOpsStatus(next: Ops) {
    if (!canUpdateStatus) return;
    setSavingStatus(true);
    setMsg(null);
    try {
      await authedFetch(`/api/vendor/orders/${encodeURIComponent(orderId)}/ops-status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ opsStatus: next }),
      });
      await load();
    } catch (e: any) {
      setMsg(e?.message || "Failed to update status");
    } finally {
      setSavingStatus(false);
    }
  }

  async function addNote() {
    if (!canUseNotes) return;
    if (noteText.trim().length < 2) return;

    setSavingNote(true);
    setMsg(null);
    try {
      await authedFetch(`/api/vendor/orders/${encodeURIComponent(orderId)}/notes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: noteText }),
      });
      setNoteText("");
      await load();
    } catch (e: any) {
      setMsg(e?.message || "Failed to add note");
    } finally {
      setSavingNote(false);
    }
  }

  function messageCustomer() {
    const phone = String(o?.customer?.phone || "").trim();
    if (!phone) {
      setMsg("No customer phone on this order. If this came from chat, continue the WhatsApp thread.");
      return;
    }

    const shortId = String(orderId).slice(0, 8);
    const text = `Hello, this is regarding your BizHub order #${shortId}.`;

    window.open(waLink(phone, text), "_blank");
  }

  return (
    <div className="min-h-screen">
      <GradientHeader title="Order details" subtitle={orderId ? `#${orderId.slice(0, 8)}` : undefined} showBack={true} />

      <div className="px-4 pb-6 space-y-3">
        {loading ? <Card className="p-4">Loadingâ€¦</Card> : null}
        {msg ? <Card className={msg.toLowerCase().includes("saved") ? "p-4 text-green-700" : "p-4 text-red-700"}>{msg}</Card> : null}

        {!loading && o ? (
          <>
            <div className="rounded-[26px] p-4 text-white shadow-float bg-gradient-to-br from-biz-accent2 to-biz-accent">
              <p className="text-xs opacity-95">Amount</p>
              <p className="text-2xl font-extrabold mt-1">{fmtNaira(amount)}</p>
              <p className="text-xs opacity-95 mt-1">
                {String(o?.paymentType || "â€”")} â€¢ <b>{String(o?.opsStatusEffective || o?.opsStatus || "â€”")}</b>
              </p>
              <p className="text-[11px] opacity-90 mt-2">Created: {fmtDate(o?.createdAt)}</p>

              {disputed ? (
                <p className="text-[11px] opacity-95 mt-2">
                  Dispute: <b>Open</b>
                </p>
              ) : null}
            </div>

            <SectionCard
              title="Customer contact"
              subtitle="Quick message shortcut"
              right={
                <Button size="sm" variant="secondary" onClick={messageCustomer} leftIcon={<MessageCircle className="h-4 w-4" />}>
                  Message
                </Button>
              }
            >
              <div className="text-sm text-gray-700 space-y-1">
                <div>
                  Name: <b className="text-biz-ink">{o?.customer?.fullName || "â€”"}</b>
                </div>
                <div>
                  Phone: <b className="text-biz-ink">{o?.customer?.phone || "â€”"}</b>
                </div>
                {o?.customer?.address ? (
                  <div>
                    Address: <b className="text-biz-ink">{o.customer.address}</b>
                  </div>
                ) : null}
                <div className="text-[11px] text-gray-500 mt-2 break-all">
                  Order ID: <b className="text-biz-ink">{orderId}</b>
                </div>

                <div className="mt-3">
                  <Button
                    variant="secondary"
                    size="sm"
                    leftIcon={<AlertTriangle className="h-4 w-4" />}
                    onClick={() => router.push(`/vendor/orders/${encodeURIComponent(orderId)}/dispute`)}
                  >
                    Report an issue
                  </Button>
                </div>
              </div>
            </SectionCard>

            <SectionCard title="Order progress" subtitle="Update how this order is moving">
              {!canUpdateStatus ? (
                <Card variant="soft" className="p-3">
                  <p className="text-sm font-bold text-biz-ink">Locked</p>
                  <p className="text-[11px] text-biz-muted mt-1">Upgrade to update order progress.</p>
                  <div className="mt-2">
                    <Button size="sm" onClick={() => router.push("/vendor/subscription")}>
                      Upgrade
                    </Button>
                  </div>
                </Card>
              ) : (
                <>
                  <SegmentedControl<Ops>
                    value={opsValue}
                    onChange={(v) => setOpsStatus(v)}
                    options={OPS_OPTIONS.map((o) => ({ value: o.value, label: o.label }))}
                    className="!grid-cols-3"
                  />
                  {savingStatus ? <p className="text-[11px] text-biz-muted mt-2">Updatingâ€¦</p> : null}
                </>
              )}

              <p className="text-[11px] text-biz-muted mt-3">
                Payment state still exists separately (escrow/transfer). This is the operational progress.
              </p>
            </SectionCard>

            <SectionCard title="Internal notes" subtitle="Private notes for your team">
              {!canUseNotes ? (
                <Card variant="soft" className="p-3">
                  <p className="text-sm font-bold text-biz-ink">Locked</p>
                  <p className="text-[11px] text-biz-muted mt-1">Upgrade to use internal notes.</p>
                  <div className="mt-2">
                    <Button size="sm" onClick={() => router.push("/vendor/subscription")}>
                      Upgrade
                    </Button>
                  </div>
                </Card>
              ) : (
                <>
                  <textarea
                    className="w-full rounded-2xl border border-biz-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-biz-accent/30 focus:border-biz-accent/40"
                    placeholder="Write a note (e.g. Customer asked for red color, dispatch tomorrow)â€¦"
                    value={noteText}
                    onChange={(e) => setNoteText(e.target.value)}
                    rows={4}
                  />
                  <div className="mt-2">
                    <Button onClick={addNote} loading={savingNote} disabled={savingNote || noteText.trim().length < 2}>
                      Add note
                    </Button>
                  </div>

                  {notes.length === 0 ? (
                    <p className="text-sm text-biz-muted mt-3">No notes yet.</p>
                  ) : (
                    <div className="mt-3 space-y-2">
                      {notes.map((n) => (
                        <div key={n.id} className="rounded-2xl border border-biz-line bg-white p-3">
                          <p className="text-sm text-gray-800 whitespace-pre-wrap">{String(n.text || "")}</p>
                          <p className="text-[11px] text-gray-500 mt-2">
                            {n.createdAtMs ? new Date(Number(n.createdAtMs)).toLocaleString() : "â€”"}
                          </p>
                        </div>
                      ))}
                    </div>
                  )}
                </>
              )}
            </SectionCard>

            <Card className="p-4">
              <div className="grid grid-cols-2 gap-2">
                <Button variant="secondary" onClick={() => router.push("/vendor/orders")}>
                  Back to orders
                </Button>
                <Button onClick={() => router.push("/vendor")}>Dashboard</Button>
              </div>
            </Card>
          </>
        ) : null}
      </div>
    </div>
  );
}

----- FILE: src\app\admin\packages\page.tsx -----
// FILE: src/app/admin/packages/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { auth } from "@/lib/firebase/client";

type PlanKey = "FREE" | "LAUNCH" | "MOMENTUM" | "APEX";

function safeNum(v: any, fallback = 0) {
  const n = Number(v);
  if (!Number.isFinite(n)) return fallback;
  return n;
}

export default function AdminPackagesPage() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [cfg, setCfg] = useState<any>(null);

  async function api(path: string, init?: RequestInit) {
    const token = await auth.currentUser?.getIdToken();
    const r = await fetch(path, { ...init, headers: { ...(init?.headers || {}), Authorization: `Bearer ${token}` } });
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j?.error || "Request failed");
    return j;
  }

  async function load() {
    setLoading(true);
    setMsg(null);
    try {
      const j = await api("/api/admin/plan-config");
      setCfg(j.config);
    } catch (e: any) {
      setMsg(e?.message || "Failed");
      setCfg(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
  }, []);

  const plans: PlanKey[] = ["FREE", "LAUNCH", "MOMENTUM", "APEX"];

  const canSave = useMemo(() => !!cfg?.plans, [cfg]);

  async function save() {
    if (!canSave) return;
    setSaving(true);
    setMsg(null);
    try {
      await api("/api/admin/plan-config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ plans: cfg.plans }),
      });
      setMsg("Saved.");
    } catch (e: any) {
      setMsg(e?.message || "Save failed");
    } finally {
      setSaving(false);
    }
  }

  function setFeature(plan: PlanKey, key: string, value: boolean) {
    setCfg((prev: any) => ({
      ...prev,
      plans: {
        ...(prev?.plans || {}),
        [plan]: {
          ...(prev?.plans?.[plan] || {}),
          features: {
            ...(prev?.plans?.[plan]?.features || {}),
            [key]: value,
          },
        },
      },
    }));
  }

  function setLimit(plan: PlanKey, key: string, value: number) {
    setCfg((prev: any) => ({
      ...prev,
      plans: {
        ...(prev?.plans || {}),
        [plan]: {
          ...(prev?.plans?.[plan] || {}),
          limits: {
            ...(prev?.plans?.[plan]?.limits || {}),
            [key]: value,
          },
        },
      },
    }));
  }

  return (
    <div className="min-h-screen">
      <GradientHeader title="Packages" subtitle="Edit features & limits (no code)" showBack={true} />

      <div className="px-4 pb-24 space-y-3">
        {loading ? <Card className="p-4">Loadingâ€¦</Card> : null}
        {msg ? <Card className="p-4">{msg}</Card> : null}

        {!loading && cfg ? (
          <>
            {plans.map((p) => {
              const f = cfg?.plans?.[p]?.features || {};
              const l = cfg?.plans?.[p]?.limits || {};

              return (
                <Card key={p} className="p-4 space-y-3">
                  <p className="text-sm font-bold text-biz-ink">{p}</p>

                  <div className="rounded-2xl border border-biz-line bg-white p-3">
                    <p className="text-xs font-bold text-gray-500">FEATURES</p>

                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <Toggle label="Marketplace" value={!!f.marketplace} onClick={(v) => setFeature(p, "marketplace", v)} />
                      <Toggle label="Store customization" value={!!f.storeCustomize} onClick={(v) => setFeature(p, "storeCustomize", v)} />
                      <Toggle label="Continue in Chat" value={!!f.continueInChat} onClick={(v) => setFeature(p, "continueInChat", v)} />
                      <Toggle label="Coupons" value={!!f.coupons} onClick={(v) => setFeature(p, "coupons", v)} />
                      <Toggle label="Assistant" value={!!f.assistant} onClick={(v) => setFeature(p, "assistant", v)} />
                      <Toggle label="Reâ€‘engagement" value={!!f.reengagement} onClick={(v) => setFeature(p, "reengagement", v)} />
                      <Toggle label="Staff" value={!!f.staff} onClick={(v) => setFeature(p, "staff", v)} />
                      <Toggle label="Promotions" value={!!f.promotions} onClick={(v) => setFeature(p, "promotions", v)} />
                      <Toggle label="Month analytics" value={!!f.monthAnalytics} onClick={(v) => setFeature(p, "monthAnalytics", v)} />
                    </div>

                    <p className="mt-3 text-[11px] text-biz-muted">
                      Tip: keep FREE usable, but restrict important growth tools.
                    </p>
                  </div>

                  <div className="rounded-2xl border border-biz-line bg-white p-3">
                    <p className="text-xs font-bold text-gray-500">LIMITS</p>

                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <LimitInput label="Max products" value={safeNum(l.maxProducts, 0)} onChange={(n) => setLimit(p, "maxProducts", n)} />
                      <LimitInput label="Orders visible" value={safeNum(l.ordersVisible, 0)} onChange={(n) => setLimit(p, "ordersVisible", n)} />
                      <LimitInput label="Reâ€‘engagement/day" value={safeNum(l.reengagementDaily, 0)} onChange={(n) => setLimit(p, "reengagementDaily", n)} />
                      <LimitInput label="Chat orders/day" value={safeNum(l.chatOrdersDaily, 0)} onChange={(n) => setLimit(p, "chatOrdersDaily", n)} />
                      <LimitInput label="Staff max" value={safeNum(l.staffMax, 0)} onChange={(n) => setLimit(p, "staffMax", n)} />
                      <LimitInput label="Coupons max" value={safeNum(l.couponsMax, 0)} onChange={(n) => setLimit(p, "couponsMax", n)} />
                      <LimitInput label="Shipping options max" value={safeNum(l.shippingOptionsMax, 0)} onChange={(n) => setLimit(p, "shippingOptionsMax", n)} />
                      <LimitInput label="Promotions max active" value={safeNum(l.promotionsMaxActive, 0)} onChange={(n) => setLimit(p, "promotionsMaxActive", n)} />
                    </div>
                  </div>
                </Card>
              );
            })}

            <Card className="p-4 space-y-2">
              <Button onClick={save} loading={saving} disabled={saving || !canSave}>
                Save changes
              </Button>
              <Button variant="secondary" onClick={load} disabled={saving}>
                Refresh
              </Button>
            </Card>
          </>
        ) : null}
      </div>
    </div>
  );
}

function Toggle({ label, value, onClick }: { label: string; value: boolean; onClick: (v: boolean) => void }) {
  return (
    <button
      type="button"
      onClick={() => onClick(!value)}
      className="rounded-2xl border border-biz-line bg-white p-3 flex items-center justify-between hover:bg-black/[0.02] transition"
    >
      <span className="text-xs font-bold text-biz-ink">{label}</span>
      <span
        className={
          value
            ? "px-3 py-1 rounded-full text-[11px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100"
            : "px-3 py-1 rounded-full text-[11px] font-bold bg-orange-50 text-orange-700 border border-orange-100"
        }
      >
        {value ? "ON" : "OFF"}
      </span>
    </button>
  );
}

function LimitInput({ label, value, onChange }: { label: string; value: number; onChange: (n: number) => void }) {
  return (
    <div className="rounded-2xl border border-biz-line bg-white p-3">
      <p className="text-[11px] text-gray-500">{label}</p>
      <Input
        type="number"
        value={String(value)}
        onChange={(e) => onChange(Number(e.target.value))}
        className="mt-2"
      />
    </div>
  );
}

----- FILE: src\app\api\escrow\confirm\route.ts -----
// FILE: src/app/api/escrow/confirm/route.ts
import { NextResponse } from "next/server";
import { adminDb } from "@/lib/firebase/admin";
import { FieldValue } from "firebase-admin/firestore";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

async function verifyPaystack(reference: string) {
  const secret = process.env.PAYSTACK_SECRET_KEY;
  if (!secret) throw new Error("Missing PAYSTACK_SECRET_KEY");

  const res = await fetch(`https://api.paystack.co/transaction/verify/${reference}`, {
    headers: { Authorization: `Bearer ${secret}` },
  });

  const data = await res.json();
  if (!data.status) throw new Error(data.message || "Paystack verify failed");
  return data.data;
}

function normalizeMetadata(raw: any) {
  if (!raw) return {};
  if (typeof raw === "string") {
    try {
      return JSON.parse(raw);
    } catch {
      return {};
    }
  }
  return raw;
}

function cleanCode(v: any) {
  const raw = String(v || "").trim().toUpperCase();
  const ok = /^[A-Z0-9]{3,20}$/.test(raw);
  return ok ? raw : "";
}

function cleanShipping(s: any) {
  if (!s || typeof s !== "object") return null;

  const optionId = s.optionId ? String(s.optionId) : null;
  const type = String(s.type || "delivery") === "pickup" ? "pickup" : "delivery";
  const name = String(s.name || "").slice(0, 60) || (type === "pickup" ? "Pickup" : "Delivery");
  const feeKobo = Number(s.feeKobo || 0);

  return {
    optionId,
    type,
    name,
    feeKobo: Number.isFinite(feeKobo) ? Math.max(0, Math.floor(feeKobo)) : 0,
  };
}

export async function POST(req: Request) {
  try {
    const { reference } = await req.json();
    if (!reference) {
      return NextResponse.json({ error: "reference is required" }, { status: 400 });
    }

    const paystackTx = await verifyPaystack(reference);

    if (paystackTx.status !== "success") {
      return NextResponse.json(
        { error: `Payment not successful: ${paystackTx.status}`, raw: paystackTx },
        { status: 400 }
      );
    }

    const metadata = normalizeMetadata(paystackTx.metadata);
    const storeSlug = metadata.storeSlug || metadata.businessSlug || metadata.slug;

    const items = Array.isArray(metadata.items) ? metadata.items : [];
    const customer = metadata.customer || {};

    const couponMeta = metadata.coupon || null;
    const couponCode = couponMeta?.code ? cleanCode(couponMeta.code) : "";
    const discountKobo = couponMeta?.discountKobo != null ? Number(couponMeta.discountKobo) : null;
    const subtotalKobo = couponMeta?.subtotalKobo != null ? Number(couponMeta.subtotalKobo) : null;

    const shipping = cleanShipping(metadata.shipping);

    if (!storeSlug) {
      return NextResponse.json(
        { error: "Missing storeSlug in metadata (expected metadata.storeSlug)" },
        { status: 400 }
      );
    }

    const bizSnap = await adminDb.collection("businesses").where("slug", "==", storeSlug).limit(1).get();

    if (bizSnap.empty) {
      return NextResponse.json({ error: "Business not found for slug" }, { status: 404 });
    }

    const bizDoc = bizSnap.docs[0];
    const businessId = bizDoc.id;

    const amountKobo = Number(paystackTx.amount || 0);
    if (!Number.isFinite(amountKobo) || amountKobo <= 0) {
      return NextResponse.json({ error: "Invalid amount from Paystack", raw: paystackTx }, { status: 400 });
    }

    const amount = amountKobo / 100;

    const nowMs = Date.now();
    const holdMs = 5 * 60 * 1000; // âœ… 5 minutes max (your instruction)
    const holdUntilMs = nowMs + holdMs;

    const txRef = adminDb.collection("transactions").doc(reference);

    const result = await adminDb.runTransaction(async (t) => {
      const existingTxSnap = await t.get(txRef);
      if (existingTxSnap.exists) {
        const txData = existingTxSnap.data() as any;
        return {
          ok: true,
          orderId: txData.orderId,
          businessSlug: txData.businessSlug,
          escrowStatus: txData.status,
          holdUntilMs: txData.holdUntilMs ?? null,
          alreadyProcessed: true,
        };
      }

      const orderRef = adminDb.collection("orders").doc();
      const orderId = orderRef.id;

      const coupon =
        couponCode
          ? {
              code: couponCode,
              discountKobo: Number.isFinite(discountKobo as any) ? Number(discountKobo) : null,
              subtotalKobo: Number.isFinite(subtotalKobo as any) ? Number(subtotalKobo) : null,
            }
          : null;

      t.set(orderRef, {
        businessId,
        businessSlug: storeSlug,
        items,
        customer,

        coupon: coupon || null,
        shipping: shipping || null,

        paymentType: "paystack_escrow",
        paymentStatus: "paid",

        payment: {
          provider: "paystack",
          reference,
          status: "success",
          channel: paystackTx.channel || null,
          paidAt: paystackTx.paid_at || null,
          feesKobo: paystackTx.fees ?? null,
        },

        escrowStatus: "held",
        orderStatus: "paid_held",

        // ops progress (Batch 2)
        opsStatus: "paid",
        opsUpdatedAtMs: nowMs,

        currency: paystackTx.currency || "NGN",
        amount,
        amountKobo,

        holdUntilMs,
        createdAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp(),
      });

      t.set(txRef, {
        orderId,
        businessId,
        businessSlug: storeSlug,
        amount,
        amountKobo,
        status: "held",
        provider: "paystack",
        reference,
        holdUntilMs,
        createdAt: FieldValue.serverTimestamp(),
      });

      const walletRef = adminDb.collection("wallets").doc(businessId);
      t.set(
        walletRef,
        {
          businessId,
          pendingBalanceKobo: FieldValue.increment(amountKobo),
          availableBalanceKobo: FieldValue.increment(0),
          totalEarnedKobo: FieldValue.increment(0),
          updatedAt: FieldValue.serverTimestamp(),
        },
        { merge: true }
      );

      if (couponCode) {
        const cRef = adminDb.collection("businesses").doc(businessId).collection("coupons").doc(couponCode);
        t.set(
          cRef,
          { usedCount: FieldValue.increment(1), updatedAtMs: Date.now(), updatedAt: FieldValue.serverTimestamp() },
          { merge: true }
        );
      }

      return {
        ok: true,
        orderId,
        businessSlug: storeSlug,
        escrowStatus: "held",
        holdUntilMs,
        alreadyProcessed: false,
      };
    });

    return NextResponse.json(result);
  } catch (e: any) {
    return NextResponse.json({ error: e?.message || "Escrow confirm failed" }, { status: 500 });
  }
}

----- FILE: src\app\admin\verification\page.tsx -----
// FILE: src/app/admin/verification/page.tsx
"use client";

import { useEffect, useState } from "react";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { auth } from "@/lib/firebase/client";

function fmtDateMs(ms?: number) {
  if (!ms) return "â€”";
  try {
    return new Date(ms).toLocaleString();
  } catch {
    return String(ms);
  }
}

export default function AdminVerificationPage() {
  const [loading, setLoading] = useState(true);
  const [msg, setMsg] = useState<string | null>(null);
  const [items, setItems] = useState<any[]>([]);
  const [note, setNote] = useState("");

  async function api(path: string, init?: RequestInit) {
    const token = await auth.currentUser?.getIdToken();
    const r = await fetch(path, { ...init, headers: { ...(init?.headers || {}), Authorization: `Bearer ${token}` } });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data?.error || "Request failed");
    return data;
  }

  async function load() {
    setLoading(true);
    setMsg(null);
    try {
      const data = await api("/api/admin/verification?status=pending");
      setItems(Array.isArray(data.items) ? data.items : []);
    } catch (e: any) {
      setMsg(e?.message || "Failed");
      setItems([]);
    } finally {
      setLoading(false);
    }
  }

  async function act(submissionId: string, tier: string, decision: "approve" | "reject") {
    try {
      await api("/api/admin/verification", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ submissionId, tier, decision, note }),
      });
      setNote("");
      await load();
    } catch (e: any) {
      alert(e?.message || "Failed");
    }
  }

  useEffect(() => {
    load();
  }, []);

  return (
    <div className="min-h-screen">
      <GradientHeader title="Verification" subtitle="Tier reviews" showBack={true} />

      <div className="px-4 pb-24 space-y-3">
        {loading ? <Card className="p-4">Loadingâ€¦</Card> : null}
        {msg ? <Card className="p-4 text-red-700">{msg}</Card> : null}

        <Card className="p-4">
          <p className="text-sm font-bold text-biz-ink">Admin note (for rejection)</p>
          <p className="text-xs text-biz-muted mt-1">Example: â€œID number mismatchâ€ or â€œAddress proof unclearâ€.</p>
          <div className="mt-2">
            <Input value={note} onChange={(e) => setNote(e.target.value)} placeholder="Reason (optional)" />
          </div>
          <div className="mt-3">
            <Button variant="secondary" onClick={load}>Refresh</Button>
          </div>
        </Card>

        {!loading && items.length === 0 ? (
          <Card className="p-4">No pending verification submissions.</Card>
        ) : null}

        <div className="space-y-3">
          {items.map((x) => {
            const biz = x.business || null;
            const tier = String(x.tier || "");
            const payload = x.payload || {};
            const proofUrls: string[] = Array.isArray(payload.proofUrls) ? payload.proofUrls : [];
            const selfieUrls: string[] = Array.isArray(payload.selfieUrls) ? payload.selfieUrls : [];

            return (
              <Card key={x.id} className="p-4">
                <p className="text-sm font-bold text-biz-ink">
                  {biz?.name || "Business"} <span className="text-biz-muted">({biz?.slug || "â€”"})</span>
                </p>

                <p className="text-[11px] text-gray-500 mt-1">
                  Tier: <b className="text-biz-ink">{tier}</b> â€¢ Submitted:{" "}
                  <b className="text-biz-ink">{fmtDateMs(Number(x.createdAtMs || 0))}</b>
                </p>

                {tier === "tier2" ? (
                  <div className="mt-2 rounded-2xl border border-biz-line bg-white p-3">
                    <p className="text-[11px] text-gray-500">ID Type</p>
                    <p className="text-sm font-bold text-biz-ink mt-1">{String(payload.idType || "â€”")}</p>
                    <p className="text-[11px] text-gray-500 mt-2">ID Number</p>
                    <p className="text-sm font-bold text-biz-ink mt-1 break-all">{String(payload.idNumber || "â€”")}</p>
                  </div>
                ) : null}

                {tier === "tier3" && proofUrls.length ? (
                  <div className="mt-3 grid grid-cols-3 gap-2">
                    {proofUrls.slice(0, 9).map((u: string) => (
                      <a key={u} href={u} target="_blank" rel="noreferrer" className="block">
                        {/* eslint-disable-next-line @next/next/no-img-element */}
                        <img src={u} alt="Proof" className="h-24 w-full object-cover rounded-2xl border" />
                      </a>
                    ))}
                  </div>
                ) : null}

                {tier === "tier1" && selfieUrls.length ? (
                  <div className="mt-3 grid grid-cols-3 gap-2">
                    {selfieUrls.slice(0, 9).map((u: string) => (
                      <a key={u} href={u} target="_blank" rel="noreferrer" className="block">
                        {/* eslint-disable-next-line @next/next/no-img-element */}
                        <img src={u} alt="Selfie" className="h-24 w-full object-cover rounded-2xl border" />
                      </a>
                    ))}
                  </div>
                ) : null}

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <Button onClick={() => act(String(x.id), tier, "approve")}>Approve</Button>
                  <Button variant="danger" onClick={() => act(String(x.id), tier, "reject")}>Reject</Button>
                </div>

                <p className="mt-2 text-[11px] text-biz-muted break-all">
                  BusinessId: {String(x.businessId || "â€”")}
                </p>
              </Card>
            );
          })}
        </div>
      </div>
    </div>
  );
}

----- FILE: src\app\api\vendor\reengagement\send\route.ts -----
// FILE: src/app/api/vendor/reengagement/send/route.ts
import { NextResponse } from "next/server";
import { requireRole } from "@/lib/auth/server";
import { adminDb } from "@/lib/firebase/admin";
import { FieldValue } from "firebase-admin/firestore";
import { requireVendorUnlocked } from "@/lib/vendor/lockServer";
import { getAssistantLimitsResolved } from "@/lib/vendor/assistantLimitsServer";
import { moderateOutboundText } from "@/lib/moderation/simpleTextGuard";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

function cleanPhone(raw: any) {
  const d = String(raw || "").replace(/[^\d]/g, "");
  return d.length >= 7 ? d : "";
}

function cleanAudience(v: any) {
  const s = String(v || "buyers").trim();
  if (s === "buyers" || s === "abandoned") return s;
  return "buyers";
}

function dayKey(d = new Date()) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

function planDailyLimit(planKey: string) {
  const k = String(planKey || "FREE").toUpperCase();
  if (k === "APEX") return 150;
  if (k === "MOMENTUM") return 60;
  if (k === "LAUNCH") return 20;
  return 0;
}

export async function POST(req: Request) {
  try {
    const me = await requireRole(req, "owner");
    if (!me.businessId) return NextResponse.json({ ok: false, error: "Missing businessId" }, { status: 400 });
    await requireVendorUnlocked(me.businessId);

    const access = await getAssistantLimitsResolved(me.businessId);
    const planKey = String(access.planKey || "FREE");
    const dailyLimit = planDailyLimit(planKey);

    if (dailyLimit <= 0) {
      return NextResponse.json({ ok: false, code: "FEATURE_LOCKED", error: "Upgrade to message past buyers." }, { status: 403 });
    }

    const body = await req.json().catch(() => ({}));
    const audience = cleanAudience(body.audience);
    const text = String(body.text || "").trim().slice(0, 1200);

    const peopleRaw = Array.isArray(body.people) ? body.people : [];
    const people = peopleRaw
      .map((x: any) => ({ phone: cleanPhone(x?.phone), key: String(x?.key || "") }))
      .filter((x: any) => !!x.phone)
      .slice(0, 500);

    if (!text) return NextResponse.json({ ok: false, error: "Message is required" }, { status: 400 });
    if (people.length < 1) return NextResponse.json({ ok: false, error: "No recipients" }, { status: 400 });

    // Moderation (policy violation)
    const mod = moderateOutboundText(text);
    if (!mod.ok) {
      await adminDb.collection("vendorPolicyViolations").doc().set({
        businessId: me.businessId,
        businessSlug: me.businessSlug ?? null,
        type: "message_blocked",
        reason: mod.reason,
        hit: mod.hit ?? null,
        audience,
        createdAtMs: Date.now(),
        createdAt: FieldValue.serverTimestamp(),
      });

      return NextResponse.json(
        { ok: false, code: "BLOCKED_BY_POLICY", error: "Message blocked by safety policy." },
        { status: 400 }
      );
    }

    const dk = dayKey();
    const counterRef = adminDb.collection("businesses").doc(me.businessId).collection("reengagementCounters").doc(dk);

    // Determine how many we can send today
    const countRequested = people.length;
    const allowed = await adminDb.runTransaction(async (t) => {
      const snap = await t.get(counterRef);
      const cur = snap.exists ? Number((snap.data() as any)?.sentCount || 0) : 0;
      const remaining = Math.max(0, dailyLimit - cur);
      const take = Math.max(0, Math.min(remaining, countRequested));

      t.set(
        counterRef,
        {
          dayKey: dk,
          planKey,
          dailyLimit,
          sentCount: cur + take,
          updatedAtMs: Date.now(),
          updatedAt: FieldValue.serverTimestamp(),
          createdAtMs: snap.exists ? (snap.data() as any)?.createdAtMs || Date.now() : Date.now(),
          createdAt: snap.exists ? (snap.data() as any)?.createdAt || FieldValue.serverTimestamp() : FieldValue.serverTimestamp(),
        },
        { merge: true }
      );

      return { take, remainingAfter: Math.max(0, remaining - take), cur, dailyLimit };
    });

    const recipients = people.slice(0, allowed.take);

    // Campaign log
    const campaignRef = adminDb.collection("reengagementCampaigns").doc();
    await campaignRef.set({
      businessId: me.businessId,
      businessSlug: me.businessSlug ?? null,
      audience,
      text,
      recipientCount: recipients.length,
      createdByUid: me.uid,
      createdAtMs: Date.now(),
      createdAt: FieldValue.serverTimestamp(),
      planKey,
    });

    return NextResponse.json({
      ok: true,
      campaignId: campaignRef.id,
      audience,
      text,
      recipients,
      limit: { planKey, dailyLimit, ...allowed },
    });
  } catch (e: any) {
    if (e?.code === "VENDOR_LOCKED") {
      return NextResponse.json({ ok: false, code: "VENDOR_LOCKED", error: "Subscribe to continue." }, { status: 403 });
    }
    return NextResponse.json({ ok: false, error: e?.message || "Failed" }, { status: 500 });
  }
}

----- FILE: src\app\api\vendor\coupons\route.ts -----
import { NextResponse } from "next/server";
import { requireRole } from "@/lib/auth/server";
import { adminDb } from "@/lib/firebase/admin";
import { FieldValue } from "firebase-admin/firestore";
import { requireVendorUnlocked } from "@/lib/vendor/lockServer";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

function hasActiveSubscription(biz: any) {
  const exp = Number(biz?.subscription?.expiresAtMs || 0);
  return !!(biz?.subscription?.planKey && exp && exp > Date.now());
}

function cleanCode(v: any) {
  const raw = String(v || "").trim().toUpperCase();
  const ok = /^[A-Z0-9]{3,20}$/.test(raw);
  return ok ? raw : "";
}

function clampInt(n: any, min: number, max: number) {
  const v = Math.floor(Number(n));
  if (!Number.isFinite(v)) return min;
  return Math.max(min, Math.min(max, v));
}

function clampKobo(n: any) {
  const v = Math.floor(Number(n));
  if (!Number.isFinite(v)) return 0;
  return Math.max(0, v);
}

export async function GET(req: Request) {
  try {
    const me = await requireRole(req, "owner");
    if (!me.businessId) return NextResponse.json({ ok: false, error: "Missing businessId" }, { status: 400 });

    await requireVendorUnlocked(me.businessId);

    const snap = await adminDb
      .collection("businesses")
      .doc(me.businessId)
      .collection("coupons")
      .limit(200)
      .get();

    const coupons = snap.docs
      .map((d) => ({ id: d.id, ...(d.data() as any) }))
      .sort((a, b) => String(a.codeUpper || a.id).localeCompare(String(b.codeUpper || b.id)));

    return NextResponse.json({ ok: true, coupons });
  } catch (e: any) {
    if (e?.code === "VENDOR_LOCKED") {
      return NextResponse.json({ ok: false, code: "VENDOR_LOCKED", error: "Subscribe to continue." }, { status: 403 });
    }
    return NextResponse.json({ ok: false, error: e?.message || "Failed" }, { status: 500 });
  }
}

export async function POST(req: Request) {
  try {
    const me = await requireRole(req, "owner");
    if (!me.businessId) return NextResponse.json({ ok: false, error: "Missing businessId" }, { status: 400 });

    const { business } = await requireVendorUnlocked(me.businessId);

    // Coupons are an advanced feature: require active subscription
    if (!hasActiveSubscription(business)) {
      return NextResponse.json(
        { ok: false, code: "SUBSCRIPTION_REQUIRED", error: "Subscribe to create discount codes." },
        { status: 403 }
      );
    }

    const body = await req.json().catch(() => ({}));

    const codeUpper = cleanCode(body.code);
    if (!codeUpper) {
      return NextResponse.json(
        { ok: false, error: "Code must be 3â€“20 characters (Aâ€“Z, 0â€“9) with no spaces." },
        { status: 400 }
      );
    }

    const type = String(body.type || "percent") === "fixed" ? "fixed" : "percent";

    // percent: 1â€“90
    const percent = clampInt(body.percent, 1, 90);

    // fixed: min 100 NGN, max 1,000,000 NGN
    const amountOffKobo = clampKobo(body.amountOffKobo);
    const minOrderKobo = clampKobo(body.minOrderKobo);
    const maxDiscountKobo = clampKobo(body.maxDiscountKobo);

    const startsAtMs = body.startsAtMs ? Number(body.startsAtMs) : null;
    const endsAtMs = body.endsAtMs ? Number(body.endsAtMs) : null;

    const usageLimitTotal = body.usageLimitTotal ? clampInt(body.usageLimitTotal, 1, 1000000) : null;

    const ref = adminDb.collection("businesses").doc(me.businessId).collection("coupons").doc(codeUpper);

    // Create/update coupon
    await ref.set(
      {
        businessId: me.businessId,
        businessSlug: business?.slug ?? me.businessSlug ?? null,

        codeUpper,
        code: codeUpper,

        active: body.active === false ? false : true,

        type, // percent | fixed
        percent: type === "percent" ? percent : null,
        amountOffKobo: type === "fixed" ? amountOffKobo : null,

        minOrderKobo: minOrderKobo || 0,
        maxDiscountKobo: maxDiscountKobo || null,

        startsAtMs: startsAtMs && Number.isFinite(startsAtMs) ? startsAtMs : null,
        endsAtMs: endsAtMs && Number.isFinite(endsAtMs) ? endsAtMs : null,

        usageLimitTotal,
        usedCount: FieldValue.increment(0),

        createdByUid: me.uid,
        createdAtMs: Date.now(),
        updatedAtMs: Date.now(),
        createdAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );

    return NextResponse.json({ ok: true, code: codeUpper });
  } catch (e: any) {
    if (e?.code === "VENDOR_LOCKED") {
      return NextResponse.json({ ok: false, code: "VENDOR_LOCKED", error: "Subscribe to continue." }, { status: 403 });
    }
    return NextResponse.json({ ok: false, error: e?.message || "Failed" }, { status: 500 });
  }
}

----- FILE: src\app\payment\promotion\callback\page.tsx -----
"use client";

import { useEffect, useState } from "react";
import { useSearchParams } from "next/navigation";
import Link from "next/link";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { Button } from "@/components/ui/Button";
import { CheckCircle2, AlertTriangle, Loader2 } from "lucide-react";

export default function PromotionCallbackPage() {
  const sp = useSearchParams();
  const reference = sp.get("reference") ?? sp.get("trxref");

  const [status, setStatus] = useState<"loading" | "error" | "ok">("loading");
  const [msg, setMsg] = useState("Confirming promotionâ€¦");

  useEffect(() => {
    let mounted = true;

    async function run() {
      try {
        if (!reference) {
          setStatus("error");
          setMsg("Missing Paystack reference.");
          return;
        }

        const r = await fetch("/api/promotions/confirm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reference }),
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data?.error || "Confirmation failed");

        if (!mounted) return;
        setStatus("ok");
        setMsg("Promotion activated. Your product(s) will start appearing more often.");
      } catch (e: any) {
        if (!mounted) return;
        setStatus("error");
        setMsg(e?.message || "Failed");
      }
    }

    run();
    return () => {
      mounted = false;
    };
  }, [reference]);

  return (
    <div className="min-h-screen">
      <GradientHeader title="Promotion" subtitle="Payment confirmation" showBack={true} />

      <div className="px-4 pb-24">
        <Card className="p-5 text-center">
          {status === "loading" ? (
            <>
              <div className="mx-auto h-14 w-14 rounded-2xl bg-biz-cream flex items-center justify-center">
                <Loader2 className="h-6 w-6 text-orange-700 animate-spin" />
              </div>
              <p className="mt-4 text-base font-bold text-biz-ink">Processingâ€¦</p>
              <p className="text-sm text-biz-muted mt-2">{msg}</p>
            </>
          ) : null}

          {status === "ok" ? (
            <>
              <div className="mx-auto h-14 w-14 rounded-2xl bg-emerald-50 flex items-center justify-center">
                <CheckCircle2 className="h-6 w-6 text-emerald-600" />
              </div>
              <p className="mt-4 text-base font-bold text-biz-ink">Done</p>
              <p className="text-sm text-biz-muted mt-2">{msg}</p>
            </>
          ) : null}

          {status === "error" ? (
            <>
              <div className="mx-auto h-14 w-14 rounded-2xl bg-red-50 flex items-center justify-center">
                <AlertTriangle className="h-6 w-6 text-red-600" />
              </div>
              <p className="mt-4 text-base font-bold text-biz-ink">Issue</p>
              <p className="text-sm text-red-700 mt-2">{msg}</p>
            </>
          ) : null}

          <p className="text-[11px] text-gray-500 mt-3 break-all">
            Reference: {reference || "â€”"}
          </p>

          <div className="mt-4 space-y-2">
            <Link href="/vendor/products" className="block">
              <Button>Back to products</Button>
            </Link>
            <Link href="/vendor" className="block">
              <Button variant="secondary">Dashboard</Button>
            </Link>
          </div>
        </Card>
      </div>
    </div>
  );
}

----- FILE: src\app\admin\reports\page.tsx -----
"use client";

import { useEffect, useState } from "react";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { Button } from "@/components/ui/Button";
import { auth } from "@/lib/firebase/client";

export default function AdminReportsPage() {
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [report, setReport] = useState<any>(null);

  async function api(path: string, init?: RequestInit) {
    const token = await auth.currentUser?.getIdToken();
    const r = await fetch(path, {
      ...init,
      headers: { ...(init?.headers || {}), Authorization: `Bearer ${token}` },
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j?.error || "Request failed");
    return j;
  }

  async function load() {
    setLoading(true);
    setMsg(null);
    try {
      const j = await api("/api/admin/reports/daily");
      setReport(j.report || null);
    } catch (e: any) {
      setMsg(e?.message || "Failed");
      setReport(null);
    } finally {
      setLoading(false);
    }
  }

  async function sendNow() {
    setSending(true);
    setMsg(null);
    try {
      const j = await api("/api/admin/reports/daily", { method: "POST" });
      setMsg(`Sent to ${j.sentTo}`);
    } catch (e: any) {
      setMsg(e?.message || "Send failed");
    } finally {
      setSending(false);
    }
  }

  useEffect(() => {
    load();
  }, []);

  return (
    <div className="min-h-screen">
      <GradientHeader title="Reports" subtitle="Daily email report" showBack={true} />

      <div className="px-4 pb-24 space-y-3">
        {loading ? <Card className="p-4">Loadingâ€¦</Card> : null}
        {msg ? <Card className="p-4">{msg}</Card> : null}

        {!loading && report ? (
          <>
            <Card className="p-4">
              <p className="text-sm font-bold text-biz-ink">Todayâ€™s report</p>
              <p className="text-xs text-biz-muted mt-1">
                Day: <b className="text-biz-ink">{report.dayKey}</b>
              </p>

              <div className="mt-3 grid grid-cols-2 gap-2">
                <Button onClick={sendNow} loading={sending}>
                  Send now (email)
                </Button>
                <Button variant="secondary" onClick={load}>
                  Refresh
                </Button>
              </div>

              <p className="mt-3 text-[11px] text-biz-muted">
                Automation is optional. If you want free daily automation, use GitHub Actions to call the POST endpoint with a token.
              </p>
            </Card>

            <Card className="p-4">
              <p className="text-sm font-bold text-biz-ink">Preview</p>
              <pre className="mt-3 text-[12px] whitespace-pre-wrap text-gray-800">
{report.text}
              </pre>
            </Card>
          </>
        ) : null}
      </div>
    </div>
  );
}

----- FILE: src\app\account\forgot\page.tsx -----
"use client";

import { useState } from "react";
import { sendPasswordResetEmail } from "firebase/auth";
import { auth } from "@/lib/firebase/client";
import GradientHeader from "@/components/GradientHeader";
import { Card } from "@/components/Card";
import { useRouter } from "next/navigation";

export default function ForgotPasswordPage() {
  const router = useRouter();

  const [email, setEmail] = useState("");
  const [msg, setMsg] = useState<string | null>(null);
  const [ok, setOk] = useState(false);
  const [loading, setLoading] = useState(false);

  async function sendLink() {
    setLoading(true);
    setMsg(null);
    setOk(false);

    try {
      await sendPasswordResetEmail(auth, email.trim());
      setOk(true);
      setMsg("Password reset link sent. Check your email inbox (and spam).");
    } catch (e: any) {
      setMsg(e?.message || "Failed to send reset link");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen">
      <GradientHeader title="Forgot Password" showBack={true} />

      <div className="px-4 pb-24">
        <Card className="p-4">
          <p className="text-base font-extrabold text-[#111827]">Reset your password</p>
          <p className="text-sm text-gray-600 mt-1">
            Enter your email and we will send a reset link.
          </p>

          <div className="mt-4 space-y-2">
            <input
              className="w-full border border-[#E7E7EE] rounded-2xl p-3 text-sm outline-none focus:ring-2 focus:ring-[#FF8A00]/35"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              autoComplete="email"
            />
          </div>

          <button
            className="mt-4 w-full rounded-2xl py-3 text-sm font-extrabold text-white shadow-[0_12px_30px_rgba(17,24,39,0.10)] bg-gradient-to-br from-[#FF6A00] to-[#FF8A00] disabled:opacity-50"
            onClick={sendLink}
            disabled={!email || loading}
          >
            {loading ? "Sendingâ€¦" : "Send reset link"}
          </button>

          <button
            className="mt-3 w-full rounded-2xl border border-[#E7E7EE] py-3 text-sm font-extrabold"
            onClick={() => router.push("/account/login")}
            disabled={loading}
          >
            Back to login
          </button>

          {msg ? (
            <p className={ok ? "mt-3 text-sm text-green-700" : "mt-3 text-sm text-red-700"}>
              {msg}
            </p>
          ) : null}
        </Card>
      </div>
    </div>
  );
}

----- FILE: src\app\api\admin\vendors\route.ts -----
import { NextResponse } from "next/server";
import { requireRole } from "@/lib/auth/server";
import { adminDb } from "@/lib/firebase/admin";
import { getEntitlement } from "@/lib/bizhubPlans";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

function toMs(v: any) {
  try {
    if (!v) return 0;
    if (typeof v?.toDate === "function") return v.toDate().getTime();
    if (typeof v?.seconds === "number") return v.seconds * 1000;
    return 0;
  } catch {
    return 0;
  }
}

export async function GET(req: Request) {
  try {
    await requireRole(req, "admin");

    const url = new URL(req.url);
    const q = String(url.searchParams.get("q") || "").trim().toLowerCase();

    const bSnap = await adminDb.collection("businesses").limit(300).get();
    const businesses = bSnap.docs.map((d) => ({ id: d.id, ...(d.data() as any) }));

    // search filter in memory (avoid Firestore composite index requirements)
    const filtered = q
      ? businesses.filter((b) => {
          const name = String(b.name || "").toLowerCase();
          const slug = String(b.slug || "").toLowerCase();
          return name.includes(q) || slug.includes(q);
        })
      : businesses;

    // attach owner email via users query (N+1; acceptable for admin list MVP)
    const out: any[] = [];
    for (const b of filtered.slice(0, 200)) {
      const uSnap = await adminDb
        .collection("users")
        .where("businessId", "==", b.id)
        .limit(1)
        .get();

      const ownerEmail = uSnap.empty ? null : String(uSnap.docs[0].data()?.email || "").trim() || null;

      const entitlement = getEntitlement({ trial: b.trial ?? null, subscription: b.subscription ?? null });

      out.push({
        id: b.id,
        name: b.name ?? null,
        slug: b.slug ?? null,
        ownerEmail,
        createdAtMs: toMs(b.createdAt),
        entitlement,
        trial: b.trial ?? null,
        subscription: b.subscription ?? null,
      });
    }

    // sort newest first
    out.sort((a, b) => Number(b.createdAtMs || 0) - Number(a.createdAtMs || 0));

    return NextResponse.json({ ok: true, vendors: out });
  } catch (e: any) {
    return NextResponse.json({ ok: false, error: e?.message || "Failed" }, { status: 500 });
  }
}

----- FILE: src\app\api\subscriptions\my\route.ts -----
import { NextResponse } from "next/server";
import { requireRole } from "@/lib/auth/server";
import { adminDb } from "@/lib/firebase/admin";
import { getEntitlement } from "@/lib/bizhubPlans";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

export async function GET(req: Request) {
  try {
    const me = await requireRole(req, "owner");
    if (!me.businessId) return NextResponse.json({ ok: false, error: "Missing businessId" }, { status: 400 });

    const bizSnap = await adminDb.collection("businesses").doc(me.businessId).get();
    if (!bizSnap.exists) return NextResponse.json({ ok: false, error: "Business not found" }, { status: 404 });

    const biz = { id: bizSnap.id, ...(bizSnap.data() as any) };

    const entitlement = getEntitlement({
      trial: biz?.trial ?? null,
      subscription: biz?.subscription ?? null,
    });

    // Avoid composite index requirements: no orderBy here
    const sSnap = await adminDb
      .collection("subscriptions")
      .where("businessId", "==", me.businessId)
      .limit(50)
      .get();

    const purchases = sSnap.docs
      .map((d) => ({ id: d.id, ...(d.data() as any) }))
      .sort((a: any, b: any) => Number(b.startedAtMs || 0) - Number(a.startedAtMs || 0))
      .slice(0, 20);

    return NextResponse.json({
      ok: true,
      business: {
        id: biz.id,
        name: biz.name ?? null,
        slug: biz.slug ?? null,
        subscription: biz.subscription ?? null,
        trial: biz.trial ?? null,
      },
      entitlement,
      purchases,
    });
  } catch (e: any) {
    return NextResponse.json({ ok: false, error: e?.message || "Failed" }, { status: 500 });
  }
}

----- FILE: src\app\api\escrow\sweep\route.ts -----
// FILE: src/app/api/escrow/sweep/route.ts
import { NextResponse } from "next/server";
import { adminDb } from "@/lib/firebase/admin";
import { releaseEscrowIfEligible } from "@/lib/escrow/releaseServer";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

/**
 * Best used with a cron that calls this endpoint every 1â€“2 minutes.
 * It releases due escrow orders (held + holdUntilMs passed) unless disputed.
 */
export async function POST() {
  try {
    const snap = await adminDb
      .collection("orders")
      .where("escrowStatus", "==", "held")
      .limit(300)
      .get();

    const list = snap.docs.map((d) => ({ id: d.id, ...(d.data() as any) }));

    const now = Date.now();
    const due = list
      .filter((o) => Number(o.holdUntilMs || 0) > 0)
      .filter((o) => Number(o.holdUntilMs || 0) <= now)
      .slice(0, 60); // keep it light per call

    let released = 0;
    let skipped = 0;

    for (const o of due) {
      const res = await releaseEscrowIfEligible({ orderId: String(o.id) });
      if ((res as any)?.ok === true && String((res as any)?.message || "").toLowerCase().includes("released")) released++;
      else skipped++;
    }

    return NextResponse.json({ ok: true, scannedHeld: list.length, due: due.length, released, skipped });
  } catch (e: any) {
    return NextResponse.json({ ok: false, error: e?.message || "Sweep failed" }, { status: 500 });
  }
}

----- FILE: src\components\ui\AppHeader.tsx -----
"use client";

import { Search, Bell } from "lucide-react";

export function AppHeader({
  title,
  subtitle,
  placeholder = "Search products or stores...",
}: {
  title: string;
  subtitle?: string;
  placeholder?: string;
}) {
  return (
    <div className="px-4 pt-6 pb-5 bg-gradient-to-b from-biz-sand to-biz-bg">
      <div className="flex items-start justify-between">
        <div>
          <div className="text-lg font-extrabold tracking-tight">
            {title}
            <span className="text-biz-accent">.</span>
          </div>
          {subtitle ? <div className="text-xs text-gray-600 mt-1">{subtitle}</div> : null}
        </div>

        <button className="h-10 w-10 rounded-xl bg-white border border-biz-line flex items-center justify-center">
          <Bell className="h-5 w-5 text-gray-600" />
        </button>
      </div>

      <div className="mt-4 relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" />
        <input
          className="w-full rounded-2xl border border-biz-line bg-white px-10 py-3 text-sm outline-none focus:ring-2 focus:ring-biz-accent/30"
          placeholder={placeholder}
        />
      </div>
    </div>
  );
}

----- FILE: src\lib\firebase\storefront.ts -----
import { db } from "@/lib/firebase/client";
import type { Business, Product } from "@/lib/types";
import {
  collection,
  getDocs,
  limit,
  query,
  where,
  doc,
  getDoc,
} from "firebase/firestore";

export async function getBusinessBySlug(slug: string): Promise<Business | null> {
  const q = query(collection(db, "businesses"), where("slug", "==", slug), limit(1));
  const snap = await getDocs(q);
  if (snap.empty) return null;

  const d = snap.docs[0];
  return { id: d.id, ...(d.data() as Omit<Business, "id">) };
}

export async function listProductsByBusinessId(businessId: string): Promise<Product[]> {
  const q = query(collection(db, "products"), where("businessId", "==", businessId));
  const snap = await getDocs(q);

  return snap.docs.map((d) => ({ id: d.id, ...(d.data() as Omit<Product, "id">) }));
}

export async function getProductById(productId: string): Promise<Product | null> {
  const ref = doc(db, "products", productId);
  const snap = await getDoc(ref);
  if (!snap.exists()) return null;

  return { id: snap.id, ...(snap.data() as Omit<Product, "id">) };
}


----- FILE: src\components\Card.tsx -----
import type { ComponentPropsWithoutRef } from "react";
import { cn } from "@/lib/cn";

type CardVariant = "default" | "soft" | "ghost";

export function Card(
  props: ComponentPropsWithoutRef<"div"> & { variant?: CardVariant }
) {
  const { className = "", variant = "default", ...rest } = props;

  const base =
    "rounded-[22px] border shadow-soft overflow-hidden";
  const styles =
    variant === "soft"
      ? "bg-biz-cream border-transparent"
      : variant === "ghost"
        ? "bg-transparent border-transparent shadow-none"
        : "bg-white border-biz-line";

  return <div className={cn(base, styles, className)} {...rest} />;
}

----- FILE: src\lib\entitlements\server.ts -----
import { adminDb } from "@/lib/firebase/admin";
import { getEntitlement, type Entitlement } from "@/lib/bizhubPlans";

export async function getBusinessEntitlementById(businessId: string): Promise<{
  business: any | null;
  entitlement: Entitlement;
}> {
  const snap = await adminDb.collection("businesses").doc(businessId).get();
  const business = snap.exists ? ({ id: snap.id, ...(snap.data() as any) } as any) : null;

  const entitlement = getEntitlement({
    trial: business?.trial ?? null,
    subscription: business?.subscription ?? null,
  });

  return { business, entitlement };
}
